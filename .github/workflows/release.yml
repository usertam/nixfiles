name: "Publish release"
on:
  workflow_dispatch:
  push:
    tags:
    - '*'
  pull_request:
    types:
    - closed
permissions:
  contents: write
jobs:
  patch-release:
    name: Make patch release
    if: >-
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'usertam-staging-bot[bot]' &&
      github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@main
      with:
        fetch-tags: true
        fetch-depth: 0
    - name: Bump the patch version
      run: |
        PREV_VERSION=$(git describe --tags --abbrev=0)
        if [[ $PREV_VERSION =~ v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
          MAJOR=${BASH_REMATCH[1]}
          MINOR=${BASH_REMATCH[2]}
          PATCH=${BASH_REMATCH[3]}
          NEXT_VERSION="v$MAJOR.$MINOR.$((PATCH + 1))"
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV
        else
          echo "Invalid version format: $PREV_VERSION" >&2
          exit 1
        fi
    - name: Wait for artifacts from ${{github.sha}}
      env:
        GH_TOKEN: ${{github.token}}
      run: |
        mkdir -p ./dist
        deadline=$(( $(date +%s) + 7200 ))
        while :; do
          printf "Checking run: "
          gh run list --json databaseId,headSha,workflowName \
            --jq '.[] | select(.headSha == "${{github.sha}}" and .workflowName == "Build tests on platforms") | .databaseId' | head -1 | tee run_id
          run_id=$(<run_id)
          if [ -n "$run_id" ]; then
            status=$(gh api repos/${{github.repository}}/actions/runs/$run_id --jq .status || echo "")
            conclusion=$(gh api repos/${{github.repository}}/actions/runs/$run_id --jq .conclusion || echo "")
            if [ "$status" = "completed" ] && [ "$conclusion" != "success" ]; then
              echo "::error::Run $run_id completed with conclusion $conclusion"
              false
            fi
            gh run download "$run_id" --dir ./dist
            break
          fi
          if [ "$(date +%s)" -le "$deadline" ]; then
            echo "Waiting for artifacts from run $run_id..."
            sleep 300
          else
            echo "::error::Timed out after 2 hours waiting for artifacts."
            false
          fi
        done
    - name: Create release
      env:
        GH_TOKEN: ${{github.token}}
      run: |
        gh release create ${{env.NEXT_VERSION}} --notes-from-tag ./dist/*/*.zst
  minor-release:
    name: Make minor release
    if: >-
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@main
    - name: Wait for artifacts from ${{github.sha}}
      env:
        GH_TOKEN: ${{github.token}}
      run: |
        mkdir -p ./dist
        deadline=$(( $(date +%s) + 7200 ))
        while :; do
          printf "Checking run: "
          gh run list --json databaseId,headSha,workflowName \
            --jq '.[] | select(.headSha == "${{github.sha}}" and .workflowName == "Build tests on platforms") | .databaseId' | head -1 | tee run_id
          run_id=$(<run_id)
          if [ -n "$run_id" ]; then
            status=$(gh api repos/${{github.repository}}/actions/runs/$run_id --jq .status || echo "")
            conclusion=$(gh api repos/${{github.repository}}/actions/runs/$run_id --jq .conclusion || echo "")
            if [ "$status" = "completed" ] && [ "$conclusion" != "success" ]; then
              echo "::error::Run $run_id completed with conclusion $conclusion"
              false
            fi
            gh run download "$run_id" --dir ./dist
            break
          fi
          if [ "$(date +%s)" -le "$deadline" ]; then
            echo "Waiting for artifacts from run $run_id..."
            sleep 300
          else
            echo "::error::Timed out after 2 hours waiting for artifacts."
            false
          fi
        done
    - name: Create release
      env:
        GH_TOKEN: ${{github.token}}
      run: |
        gh release create ${{github.ref_name}} --notes-from-tag ./dist/*/*.zst
