name: "Determinism checks"

on:
  workflow_dispatch:
  schedule:
  - cron: '0 0 * * MON'

jobs:
  build-linux-determinism-check:
    name: Build Linux with determinism checks
    strategy:
      matrix:
        include:
        - config: generic.docker
          system: x86_64-linux
          extras: [ release ]
        - config: generic.docker
          system: aarch64-linux
          extras: [ release ]
        - config: installer
          system: x86_64-linux
          extras: [ release, vm ]
        - config: installer
          system: aarch64-linux
          extras: [ release, vm ]
        - config: slate
          system: aarch64-linux
          extras: [ release, vm ]
        - config: nova
          system: x86_64-linux
          extras: [ vm ]
        - config: tsrvbld
          system: x86_64-linux
          extras: [ vm ]
      fail-fast: false
    runs-on: ${{matrix.system == 'x86_64-linux' && 'ubuntu-24.04' || 'ubuntu-24.04-arm'}}
    steps:
    - uses: actions/checkout@main
      with:
        ref: ${{github.ref}}
    - uses: DeterminateSystems/nix-installer-action@main
      with:
        determinate: false
    - uses: cachix/cachix-action@master
      with:
        name: usertam-nixfiles
        authToken: ${{secrets.CACHIX_AUTH_TOKEN}}
        skipAddingSubstituter: true
    - name: Set up swap
      run: |
        sudo fallocate -l 10G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
    - name: Set up local overlays
      run: |
        sudo mkdir -p /overlay/{a,b}{/nix,-work,-upper}
        sudo mount -t overlay overlay \
          -o lowerdir=/nix \
          -o upperdir=/overlay/a-upper \
          -o workdir=/overlay/a-work \
          /overlay/a/nix
        sudo mount -t overlay overlay \
          -o lowerdir=/nix \
          -o upperdir=/overlay/b-upper \
          -o workdir=/overlay/b-work \
          /overlay/b/nix
    - name: Prefetch prebuilt dependencies
      run: |
        nix-store --query --references \
          $(nix eval --raw .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.toplevel.drvPath) \
          | xargs nix-store --realise --max-jobs 0 || true
    - name: Bind mount /nix -> /overlay/a/nix
      run: |
        sudo systemctl stop nix-daemon
        sudo mount --bind /overlay/a/nix /nix
        sudo systemctl start nix-daemon
        sudo systemctl status nix-daemon
    - name: First build toplevel for ${{matrix.system}}.${{matrix.config}}
      run: |
        sudo $(which nix) build -L \
          .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.toplevel
    - name: First build vm for ${{matrix.system}}.${{matrix.config}}
      if: contains(matrix.extras, 'vm')
      run: |
        sudo $(which nix) build -L \
          .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.vm
    - name: First build release for ${{matrix.system}}.${{matrix.config}}
      if: contains(matrix.extras, 'release')
      run: |
        sudo $(which nix) build -L \
          .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.release
    - name: Bind mount /nix -> /overlay/b/nix
      run: |
        sudo systemctl stop nix-daemon
        sudo umount /nix
        sudo mount --bind /overlay/b/nix /nix
        sudo systemctl start nix-daemon
        sudo systemctl status nix-daemon
    - name: Second build toplevel for ${{matrix.system}}.${{matrix.config}}
      run: |
        sudo $(which nix) build -L \
          .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.toplevel
    - name: Second build vm for ${{matrix.system}}.${{matrix.config}}
      if: contains(matrix.extras, 'vm')
      run: |
        sudo $(which nix) build -L \
          .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.vm
    - name: Second build release for ${{matrix.system}}.${{matrix.config}}
      if: contains(matrix.extras, 'release')
      run: |
        sudo $(which nix) build -L \
          .#packages.${{matrix.system}}.nixosConfigurations.${{matrix.config}}.config.system.build.release
    - name: Remove bind mounts on /nix
      run: |
        sudo systemctl stop nix-daemon
        sudo umount /nix
        sudo systemctl start nix-daemon
        sudo systemctl status nix-daemon
    - name: Run diffoscope on the overlays
      run: |
        sudo "$(which nix)" run nixpkgs#diffoscopeMinimal -- \
          --markdown diffoscope.md \
          --exclude-directory-metadata recursive \
          /overlay/a-upper/store /overlay/b-upper/store || {
            echo "diff_exists=true" >> $GITHUB_ENV
            echo "::warning::Builds may not be deterministic, check diffoscope.md for details"
            false
        }
    - uses: actions/upload-artifact@main
      if: always() && env.diff_exists == 'true'
      with:
        name: ${{matrix.system}}-${{matrix.config}}-diffoscope
        path: |
          diffoscope.md

  determinism-status:
    name: Determinism Status
    runs-on: ubuntu-latest
    needs: [build-linux-determinism-check]
    if: always()
    steps:
    - run: ${{!contains(needs.*.result, 'failure')}}
